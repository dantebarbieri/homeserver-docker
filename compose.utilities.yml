# Utility services
# vaultwarden, syncthing, ntfy

services:
  vaultwarden:
    extends:
      file: compose.common.yml
      service: common-service
    image: vaultwarden/server:latest
    container_name: vaultwarden
    networks:
      - default
    volumes:
      - vw-data:/data

  syncthing:
    extends:
      file: compose.common.yml
      service: common-service
    image: syncthing/syncthing
    container_name: syncthing
    hostname: syncthing
    environment:
      - PUID=${UID}
      - PGID=${GID}
    volumes:
      - ${DATA}/syncthing:/var/syncthing
    network_mode: host
    healthcheck:
      test: curl -fkLsS -m 2 127.0.0.1:8384/rest/noauth/health | grep -o --color=never OK || exit 1
      interval: 1m
      timeout: 10s
      retries: 3

  ntfy:
    extends:
      file: compose.common.yml
      service: common-service
    image: binwiederhier/ntfy:latest
    container_name: ntfy
    command:
      - serve
    healthcheck:
      test: ["CMD-SHELL", "wget -q --tries=1 https://ntfy.danteb.com/v1/health -O - | grep -Eo '\"healthy\"\\s*:\\s*true' || exit 1"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 40s
    environment:
      TZ: ${TZ}
    volumes:
      - ${DATA}/ntfy/config:/etc/ntfy
      - ${DATA}/ntfy/cache:/var/cache/ntfy
    networks:
      - default

volumes:
  vw-data:
